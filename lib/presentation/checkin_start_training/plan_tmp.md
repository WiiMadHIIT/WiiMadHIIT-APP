# Checkin Training æ¨¡å—æ”¹é€ è®¡åˆ’

## ğŸ—ï¸ æ¶æ„å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  checkin_training_page.dart (UI)                               â”‚
â”‚  â””â”€â”€ è°ƒç”¨ ViewModel æ–¹æ³•                                        â”‚
â”‚  â””â”€â”€ ç®¡ç†æœ¬åœ°UIçŠ¶æ€                                             â”‚
â”‚  â””â”€â”€ å¤„ç†ç”¨æˆ·äº¤äº’                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ViewModel Layer                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  checkin_training_viewmodel.dart (çŠ¶æ€ç®¡ç†)                     â”‚
â”‚  â””â”€â”€ ç®¡ç†ä¸šåŠ¡çŠ¶æ€                                               â”‚
â”‚  â””â”€â”€ è°ƒç”¨ UseCase                                              â”‚
â”‚  â””â”€â”€ å¤„ç†æ•°æ®è½¬æ¢                                               â”‚
â”‚  â””â”€â”€ é€šçŸ¥UIæ›´æ–°                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Domain Layer                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UseCase: get_training_data_and_video_config_usecase.dart      â”‚
â”‚  â””â”€â”€ å®šä¹‰ä¸šåŠ¡æ“ä½œ                                               â”‚
â”‚  â””â”€â”€ è°ƒç”¨ Repository                                           â”‚
â”‚  â””â”€â”€ è°ƒç”¨ Service                                              â”‚
â”‚                                                                 â”‚
â”‚  Service: checkin_training_service.dart                         â”‚
â”‚  â””â”€â”€ çº¯ä¸šåŠ¡é€»è¾‘                                                 â”‚
â”‚  â””â”€â”€ æ•°æ®éªŒè¯                                                   â”‚
â”‚  â””â”€â”€ ä¸šåŠ¡è®¡ç®—                                                   â”‚
â”‚                                                                 â”‚
â”‚  Entities:                                                      â”‚
â”‚  â”œâ”€â”€ training_history_item.dart                                 â”‚
â”‚  â”œâ”€â”€ training_result.dart                                       â”‚
â”‚  â””â”€â”€ training_session_config.dart                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Layer                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Repository: checkin_training_repository.dart                   â”‚
â”‚  â””â”€â”€ æ•°æ®æºæŠ½è±¡                                                 â”‚
â”‚  â””â”€â”€ è°ƒç”¨ API                                                  â”‚
â”‚  â””â”€â”€ æ•°æ®æ˜ å°„                                                   â”‚
â”‚                                                                 â”‚
â”‚  API: checkin_training_api.dart                                â”‚
â”‚  â””â”€â”€ HTTP è¯·æ±‚                                                 â”‚
â”‚  â””â”€â”€ ç½‘ç»œé€šä¿¡                                                   â”‚
â”‚                                                                 â”‚
â”‚  Models: checkin_training_api_model.dart                        â”‚
â”‚  â””â”€â”€ API æ•°æ®æ¨¡å‹                                               â”‚
â”‚  â””â”€â”€ JSON åºåˆ—åŒ–                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµå‘

### 1. æ•°æ®è·å–æµç¨‹
```
UI â†’ ViewModel â†’ UseCase â†’ Repository â†’ API â†’ Backend
Backend â†’ API â†’ Repository â†’ UseCase â†’ ViewModel â†’ UI
```

### 2. æ•°æ®æäº¤æµç¨‹
```
UI â†’ ViewModel â†’ UseCase â†’ Repository â†’ API â†’ Backend
Backend â†’ API â†’ Repository â†’ UseCase â†’ ViewModel â†’ UI (æœ¬åœ°æ›´æ–°)
```

## ğŸ¯ æ”¹é€ æ ¸å¿ƒåŸåˆ™

### 1. **çŠ¶æ€ç®¡ç†ç»Ÿä¸€åŒ–**
- æ‰€æœ‰ä¸šåŠ¡çŠ¶æ€éƒ½åœ¨ ViewModel ä¸­ç®¡ç†
- Page åªè´Ÿè´£ UI æ¸²æŸ“å’Œç”¨æˆ·äº¤äº’
- é¿å…åœ¨ Page ä¸­ç»´æŠ¤ä¸šåŠ¡æ•°æ®

### 2. **æ•°æ®æµä¼˜åŒ–**
- æäº¤åç›´æ¥æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œé¿å…é‡æ–°è¯·æ±‚
- ä½¿ç”¨ API è¿”å›æ•°æ®æ›´æ–°æœ¬åœ°è®°å½•
- å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚

### 3. **ä¸´æ—¶æ•°æ®ç®¡ç†**
- ä¸´æ—¶æ•°æ®ï¼ˆå¦‚ `tmpResult`ï¼‰ç»Ÿä¸€åœ¨ ViewModel ä¸­ç®¡ç†
- æä¾›æ¸…æ™°çš„æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ”¯æŒä¸´æ—¶è®°å½•å’Œæ­£å¼è®°å½•çš„è½¬æ¢

## ğŸ“‹ æ”¹é€ æ­¥éª¤æ¸…å•

### ç¬¬ä¸€æ­¥ï¼šåˆ†æç°æœ‰æ¶æ„
- [ ] è¯†åˆ«å½“å‰ Page ä¸­çš„ä¸šåŠ¡çŠ¶æ€å˜é‡
- [ ] è¯†åˆ«å½“å‰ Page ä¸­çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•
- [ ] åˆ†ææ•°æ®è·å–å’Œæäº¤æµç¨‹
- [ ] è¯†åˆ«å¯ä»¥ä¼˜åŒ–çš„ç½‘ç»œè¯·æ±‚

### ç¬¬äºŒæ­¥ï¼šè®¾è®¡ ViewModel ç»“æ„
- [ ] å®šä¹‰çŠ¶æ€å˜é‡ï¼ˆç§æœ‰å˜é‡ + getterï¼‰
- [ ] è®¾è®¡ä¸šåŠ¡æ–¹æ³•æ¥å£
- [ ] è§„åˆ’æ•°æ®è½¬æ¢é€»è¾‘
- [ ] è®¾è®¡é”™è¯¯å¤„ç†æœºåˆ¶

### ç¬¬ä¸‰æ­¥ï¼šé‡æ„ Page å±‚
- [ ] ç§»é™¤ä¸šåŠ¡çŠ¶æ€å˜é‡
- [ ] ç§»é™¤ä¸šåŠ¡é€»è¾‘æ–¹æ³•
- [ ] æ›´æ–°æ–¹æ³•è°ƒç”¨ä¸º ViewModel è°ƒç”¨
- [ ] ä¿æŒ UI ç›¸å…³çŠ¶æ€å’Œæ–¹æ³•

### ç¬¬å››æ­¥ï¼šä¼˜åŒ–æ•°æ®æµç¨‹
- [ ] å®ç°æäº¤åçš„æœ¬åœ°çŠ¶æ€æ›´æ–°
- [ ] ä¼˜åŒ–ä¸´æ—¶æ•°æ®ç®¡ç†
- [ ] å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
- [ ] å®ç°æ•°æ®åŒæ­¥æœºåˆ¶

### ç¬¬äº”æ­¥ï¼šæµ‹è¯•å’ŒéªŒè¯
- [ ] éªŒè¯æ•°æ®æµæ­£ç¡®æ€§
- [ ] æµ‹è¯•é”™è¯¯å¤„ç†
- [ ] éªŒè¯æ€§èƒ½æå‡
- [ ] æ£€æŸ¥å†…å­˜æ³„æ¼

## ğŸ”§ å…·ä½“æ”¹é€ ç¤ºä¾‹

### 1. çŠ¶æ€å˜é‡è¿ç§»
```dart
// âŒ ä¹‹å‰ï¼šåœ¨ Page ä¸­
class _CheckinTrainingPageState extends State<CheckinTrainingPage> {
  List<Map<String, dynamic>> tmpResult = [];
  int _maxCounts = 0;
}

// âœ… ä¹‹åï¼šåœ¨ ViewModel ä¸­
class CheckinTrainingViewModel extends ChangeNotifier {
  List<Map<String, dynamic>> _tmpResult = [];
  List<Map<String, dynamic>> get tmpResult => _tmpResult;
  
  int getMaxCountsFromTmpResult() {
    if (_tmpResult.isEmpty) return 0;
    return _tmpResult.map((e) => e['counts'] as int).reduce(max);
  }
}
```

### 2. æ–¹æ³•è°ƒç”¨æ›´æ–°
```dart
// âŒ ä¹‹å‰ï¼šç›´æ¥æ“ä½œæœ¬åœ°çŠ¶æ€
void _addRoundToTmpResult(int counts) {
  final roundResult = {
    "roundNumber": currentRound,
    "counts": counts,
    "timestamp": DateTime.now().millisecondsSinceEpoch,
  };
  tmpResult.add(roundResult);
}

// âœ… ä¹‹åï¼šè°ƒç”¨ ViewModel æ–¹æ³•
void _addRoundToTmpResult(int counts) {
  final viewModel = context.read<CheckinTrainingViewModel>();
  viewModel.addRoundToTmpResult(currentRound, counts);
}
```

### 3. æ•°æ®æµç¨‹ä¼˜åŒ–
```dart
// âŒ ä¹‹å‰ï¼šæäº¤åé‡æ–°è¯·æ±‚æ•°æ®
await viewModel.submitTrainingResult(trainingResult);
await viewModel.refreshHistory(widget.trainingId, productId: widget.productId);

// âœ… ä¹‹åï¼šæäº¤åç›´æ¥æ›´æ–°æœ¬åœ°çŠ¶æ€
final response = await viewModel.submitTrainingResult(trainingResult);
if (response != null) {
  // æ•°æ®å·²ç»åœ¨ ViewModel ä¸­æ›´æ–°ï¼Œæ— éœ€é‡æ–°è¯·æ±‚
  print('âœ… Training result submitted successfully with rank: ${response.rank}');
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç‚¹

### 1. **å‡å°‘ç½‘ç»œè¯·æ±‚**
- æäº¤åç›´æ¥æ›´æ–°æœ¬åœ°çŠ¶æ€
- é¿å…é‡å¤çš„æ•°æ®è·å–
- å®ç°æ™ºèƒ½çš„æ•°æ®åŒæ­¥

### 2. **çŠ¶æ€ç®¡ç†ä¼˜åŒ–**
- ç»Ÿä¸€çŠ¶æ€ç®¡ç†ï¼Œé¿å…çŠ¶æ€ä¸ä¸€è‡´
- å‡å°‘ä¸å¿…è¦çš„ setState è°ƒç”¨
- ä¼˜åŒ–æ•°æ®è½¬æ¢é€»è¾‘

### 3. **å†…å­˜ç®¡ç†**
- åŠæ—¶æ¸…ç†ä¸´æ—¶æ•°æ®
- é¿å…å†…å­˜æ³„æ¼
- ä¼˜åŒ–å¤§å¯¹è±¡çš„ä½¿ç”¨

## ğŸ“š æœ€ä½³å®è·µ

### 1. **å‘½åè§„èŒƒ**
- ViewModel æ–¹æ³•ä½¿ç”¨åŠ¨è¯å¼€å¤´
- ç§æœ‰å˜é‡ä½¿ç”¨ä¸‹åˆ’çº¿å‰ç¼€
- å¸¸é‡ä½¿ç”¨å¤§å†™å­—æ¯

### 2. **é”™è¯¯å¤„ç†**
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- é”™è¯¯çŠ¶æ€çš„UIåé¦ˆ

### 3. **ä»£ç ç»„ç»‡**
- ç›¸å…³åŠŸèƒ½ç»„ç»‡åœ¨ä¸€èµ·
- æ¸…æ™°çš„æ–¹æ³•åˆ†ç»„
- é€‚å½“çš„æ³¨é‡Šå’Œæ–‡æ¡£

## ğŸ” å¸¸è§é™·é˜±

### 1. **çŠ¶æ€ä¸ä¸€è‡´**
- ç¡®ä¿ ViewModel å’Œ Page çŠ¶æ€åŒæ­¥
- é¿å…åœ¨ Page ä¸­ç›´æ¥ä¿®æ”¹ ViewModel æ•°æ®
- ä½¿ç”¨ notifyListeners() é€šçŸ¥æ›´æ–°

### 2. **å†…å­˜æ³„æ¼**
- åŠæ—¶å–æ¶ˆ Timer å’Œ Stream è®¢é˜…
- é¿å…åœ¨å¼‚æ­¥æ“ä½œä¸­å¼•ç”¨å·²é”€æ¯çš„ç»„ä»¶
- ä½¿ç”¨ mounted æ£€æŸ¥

### 3. **æ€§èƒ½é—®é¢˜**
- é¿å…åœ¨ build æ–¹æ³•ä¸­è¿›è¡Œå¤æ‚è®¡ç®—
- åˆç†ä½¿ç”¨ setState å’Œ notifyListeners
- ä¼˜åŒ–æ•°æ®è½¬æ¢å’Œè¿‡æ»¤é€»è¾‘

## ğŸ“ æ€»ç»“

è¿™å¥—æ”¹é€ æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯ï¼š
1. **ç»Ÿä¸€çŠ¶æ€ç®¡ç†** - æ‰€æœ‰ä¸šåŠ¡çŠ¶æ€éƒ½åœ¨ ViewModel ä¸­
2. **ä¼˜åŒ–æ•°æ®æµç¨‹** - å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
3. **æå‡ä»£ç è´¨é‡** - æ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œä»£ç ç»„ç»‡
4. **æ”¹å–„ç”¨æˆ·ä½“éªŒ** - æ›´å¿«çš„å“åº”é€Ÿåº¦å’Œæ›´æµç•…çš„äº¤äº’

é€šè¿‡éµå¾ªè¿™ä¸ªæ”¹é€ è®¡åˆ’ï¼Œå¯ä»¥æ˜¾è‘—æå‡ä»£ç çš„å¯ç»´æŠ¤æ€§ã€æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚
